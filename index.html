<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>SynapseCam</title>
    <style>
        *,
        *::before,
        *::after {
            box-sizing: border-box;
        }

        :root {
            --bg: #f5f7fb;
            --card: #ffffff;
            --text: #0d0d0d;
            --muted: #333b47;
            --border: #e5e7eb;
            --shadow: 0 6px 20px rgba(15, 23, 42, 0.08);
            --radius: 14px;
            --gap: 12px;
            --pad: 12px;
            --header: 40px;
        }

        html,
        body {
            height: 100%;
        }

        body {
            margin: 0;
            height: 100vh;
            overflow: hidden;
            font-family: system-ui, sans-serif;
            color: var(--text);
            background: radial-gradient(900px 520px at 8% -10%, #eef2ff 0%, transparent 60%),
                radial-gradient(900px 720px at 100% 0%, #f0fdf4 0%, transparent 50%),
                var(--bg);
            display: grid;
            grid-template-rows: var(--header) 1fr;
            gap: var(--gap);
            padding: var(--gap);
        }

        .layout {
            display: grid;
            grid-template-columns: minmax(480px, 52%) 1fr;
            gap: var(--gap);
            height: calc(100vh - (var(--header) + 3 * var(--gap)));
            min-height: 0;
        }

        header {
            display: flex;
            align-items: center;
            padding: 0 4px;
        }

        header h1 {
            margin: 0;
            font-size: 24px;
            font-weight: 700;
            letter-spacing: .2px;
        }

        .left-pane {
            display: grid;
            grid-template-rows: minmax(0, 1fr) auto;
            gap: var(--gap);
            min-height: 0;
        }

        .video-card {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            padding: var(--pad);
            display: grid;
            grid-template-rows: 1fr;
            min-height: 0;
        }

        #videoFeed {
            width: 100%;
            height: 100%;
            max-height: 100%;
            aspect-ratio: 4 / 3;
            min-height: 280px;
            border: 0;
            border-radius: 12px;
            background: #000;
            object-fit: cover;
            transform: scaleX(-1);
        }

        #canvas {
            display: none;
        }

        .controls {
            display: flex;
            gap: 10px;
            align-items: center;
            justify-content: flex-start;
            flex-wrap: wrap;
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            padding: 8px 10px;
        }

        label {
            font-weight: 600;
            color: var(--muted);
            font-size: 16px;
        }

        select,
        input,
        textarea,
        button {
            font: inherit;
        }

        select,
        input {
            padding: 8px 10px;
            border-radius: 10px;
            border: 1px solid var(--border);
            background: #fff;
        }

        button {
            padding: 8px 14px;
            font-weight: 600;
            border: 0;
            border-radius: 10px;
            color: #fff;
            cursor: pointer;
            background: #2563eb;
        }

        button:disabled {
            background-color: #9ca3af;
            cursor: not-allowed;
        }

        #startButton.start {
            background: #16a34a;
        }

        #startButton.stop {
            background: #dc2626;
        }

        .right-pane {
            display: grid;
            grid-template-rows: auto minmax(80px, .3fr) minmax(120px, .7fr);
            gap: var(--gap);
            min-height: 0;
        }

        .card {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            padding: var(--pad);
            display: grid;
            gap: 8px;
            min-height: 0;
        }

        .field label {
            font-size: 16px;
            color: var(--muted);
            font-weight: 700;
        }

        .field input[type="text"] {
            width: 100%;
            height: 40px;
        }

        textarea {
            width: 100% !important;
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 10px 12px;
            font-size: 16px;
            line-height: 1.4;
            white-space: pre-wrap;
            word-break: break-word;
            background: #fff;
            resize: vertical;
            min-height: 0;
        }

        .response-wrap {
            display: grid;
            grid-template-rows: auto 1fr;
            gap: 8px;
            min-height: 0;
        }

        #responseText {
            height: 100% !important;
            min-height: 150px !important;
            max-height: 38vh !important;
            overflow: auto;
        }

        .hint {
            color: var(--muted);
            font-size: 12px;
        }

        @media (max-width: 980px) {
            .layout {
                grid-template-columns: 1fr;
                height: calc(100vh - (var(--header) + 3 * var(--gap)));
            }

            .right-pane {
                grid-template-rows: auto minmax(100px, .38fr) minmax(120px, .62fr);
            }

            #responseText {
                max-height: 34vh !important;
            }
        }
    </style>
</head>

<body>
    <header>
        <h1>SynapseCam</h1>
    </header>

    <main class="layout">
        <section class="left-pane">
            <div class="video-card">
                <video id="videoFeed" autoplay playsinline></video>
                <canvas id="canvas" class="hidden"></canvas>
            </div>

            <div class="controls">
                <label for="intervalSelect">Interval between 2 requests:</label>
                <select id="intervalSelect" name="Interval between 2 requests" disabled>
                    <option value="100">100ms</option>
                    <option value="250">250ms</option>
                    <option value="500" selected>500ms</option>
                    <option value="1000">1s</option>
                    <option value="2000">2s</option>
                </select>
                <button id="cameraToggleButton" style="margin-left: auto;">Turn Camera On</button>
                <button id="startButton" class="start" disabled>Start</button>
            </div>
        </section>

        <aside class="right-pane">
            <div class="card field">
                <label for="baseURL">Base API</label>
                <input id="baseURL" type="text" value="http://localhost:8080" />
                <div class="hint">Change only if your API runs elsewhere.</div>
            </div>

            <div class="card field response-wrap">
                <label for="instructionText">Instruction</label>
                <textarea id="instructionText" name="Instruction"
                    placeholder="Describe what you want the model to do..."></textarea>
            </div>

            <div class="card field response-wrap">
                <label for="responseText">Response</label>
                <textarea id="responseText" name="Response" readonly
                    placeholder="Server response will appear here..."></textarea>
            </div>
        </aside>
    </main>

    <script>
        const video = document.getElementById('videoFeed');
        const canvas = document.getElementById('canvas');
        const baseURL = document.getElementById('baseURL');
        const instructionText = document.getElementById('instructionText');
        const responseText = document.getElementById('responseText');
        const intervalSelect = document.getElementById('intervalSelect');
        const startButton = document.getElementById('startButton');
        const cameraToggleButton = document.getElementById('cameraToggleButton');

        instructionText.value = "What do you see?";

        let stream;
        let intervalId;
        let isProcessing = false;

        async function sendChatCompletionRequest(instruction, imageBase64URL) {
            const response = await fetch(`${baseURL.value}/v1/chat/completions`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    max_tokens: 100,
                    messages: [{
                        role: 'user',
                        content: [{
                            type: 'text',
                            text: instruction
                        }, {
                            type: 'image_url',
                            image_url: {
                                url: imageBase64URL,
                            }
                        }]
                    }, ]
                })
            });
            if (!response.ok) {
                const errorData = await response.text();
                return `Server error: ${response.status} - ${errorData}`;
            }
            const data = await response.json();
            return data.choices[0].message.content;
        }

        async function startCamera() {
            try {
                stream = await navigator.mediaDevices.getUserMedia({
                    video: true,
                    audio: false
                });
                video.srcObject = stream;
                responseText.value = "Camera is on. Ready to start processing.";
                
                cameraToggleButton.textContent = 'Turn Camera Off';
                intervalSelect.disabled = false;
                startButton.disabled = false;
            } catch (err) {
                console.error("Error accessing camera:", err);
                responseText.value = `Error accessing camera: ${err.name} - ${err.message}. Please ensure permissions are granted and you are on HTTPS or localhost.`;
                alert(`Error accessing camera: ${err.name}. Make sure you've granted permission and are on HTTPS or localhost.`);
            }
        }

        function stopCamera() {
            if (isProcessing) {
                handleStop();
            }

            if (stream) {
                stream.getTracks().forEach(track => track.stop());
            }
            video.srcObject = null;
            stream = null;
            responseText.value = "Camera is off.";

            cameraToggleButton.textContent = 'Turn Camera On';
            intervalSelect.disabled = true;
            startButton.disabled = true;
        }

        function captureImage() {
            if (!stream || !video.videoWidth) {
                console.warn("Video stream not ready for capture.");
                return null;
            }
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            const context = canvas.getContext('2d');
            context.drawImage(video, 0, 0, canvas.width, canvas.height);
            return canvas.toDataURL('image/jpeg', 0.8);
        }

        async function sendData() {
            if (!isProcessing) return;

            const instruction = instructionText.value;
            const imageBase64URL = captureImage();

            if (!imageBase64URL) {
                responseText.value = "Failed to capture image. Stream might not be active.";
                return;
            }

            const payload = {
                instruction: instruction,
                imageBase64URL: imageBase64URL
            };

            try {
                const response = await sendChatCompletionRequest(payload.instruction, payload.imageBase64URL);
                responseText.value = response.trim();
            } catch (error) {
                console.error('Error sending data:', error);
                responseText.value = `Error: ${error.message}`;
            }
        }

        function handleStart() {
            if (!stream) {
                responseText.value = "Camera not available. Cannot start.";
                alert("Camera not available. Please turn it on first.");
                return;
            }
            isProcessing = true;
            startButton.textContent = "Stop";
            startButton.classList.remove('start');
            startButton.classList.add('stop');

            instructionText.disabled = true;
            intervalSelect.disabled = true;
            cameraToggleButton.disabled = true;

            responseText.value = "Processing started...";

            const intervalMs = parseInt(intervalSelect.value, 10);

            sendData();

            intervalId = setInterval(sendData, intervalMs);
        }

        function handleStop() {
            isProcessing = false;
            if (intervalId) {
                clearInterval(intervalId);
                intervalId = null;
            }
            startButton.textContent = "Start";
            startButton.classList.remove('stop');
            startButton.classList.add('start');

            instructionText.disabled = false;
            intervalSelect.disabled = false;
            cameraToggleButton.disabled = false;

            if (responseText.value.startsWith("Processing started...")) {
                responseText.value = "Processing stopped.";
            }
        }

        cameraToggleButton.addEventListener('click', () => {
            if (stream && stream.active) {
                stopCamera();
            } else {
                startCamera();
            }
        });

        startButton.addEventListener('click', () => {
            if (isProcessing) {
                handleStop();
            } else {
                handleStart();
            }
        });

        window.addEventListener('DOMContentLoaded', () => {
             responseText.value = "Turn on the camera to begin.";
        });

        window.addEventListener('beforeunload', () => {
            stopCamera();
        });
    </script>
</body>

</html>